#!/bin/sh
# nyaa-init is a compatibility layer across multiple init systems.
# It allows you to run the init system *you* choose, while having low maintenance cost.
# It is *not* meant to be ran as PID 1, and never should be.

err() {
  echo "nyaa-init: $@"
  exit 1
}

info() {
  echo "nyaa-init: $@"
}

chkroot() {
  echo "test"
}

# runit <-> nyaa-init <-> service
# Usage: nyaa-init enable service
runit_enable() {
  chkroot
  [ ! -f "/etc/nyaa.d/$1" ] && err "Service couldn't be found"
  
  if [ ! -f "/etc/sv/nyaa_$1" ]; then
    info "Creating service for runit"
    mkdir -p "/etc/sv/nyaa_$1"
    echo "#!/bin/sh" > "/etc/sv/nyaa_$1/run"
    echo "# This file is autogenerated by nyaa-init" >> "/etc/sv/nyaa_$1/run"
    echo "nyaa-init start $1" >> "/etc/sv/nyaa_$1/run"
  fi

    ln -s "/etc/sv/nyaa_$1" "/var/service/nyaa_$1" || err "Linking the created service failed"
    info "Linked /etc/sv/nyaa_$1 -> /var/service/nyaa_$1"
}

runit_start() {
  # WIP: ADD DEPENDS CODE
  unset EXECPRE
  unset EXECPOST
  . "/etc/nyaa.d/$1" || err "Service doesn't exist"
  info "starting $NAME, $DESC"
  $EXECPRE
  $EXEC
  $EXECPOST
}


case "$1" in
  "enable")
    runit_enable "$2" # Add init detection code
  ;;
  "start")
    runit_start "$2" # Add init detection code
  ;;
  "status")
    echo "WIP"
  ;;
  "disable")
    echo "WIP"
  ;;
  *)
    echo "usage: nyaa-init [enable,start,status,disable] service"
esac

#!/bin/sh
# nyaa-init is a compatibility layer across multiple init systems.
# It allows you to run the init system *you* choose, while having low maintenance cost.
# It is *not* meant to be ran as PID 1, and never should be.
# Copyright 2022 Kreato
#
# This file is part of Kreato Linux.
#
# Kreato Linux is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Kreato Linux is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Kreato Linux.  If not, see <https://www.gnu.org/licenses/>. Copyright 2022 Kreato

err() {
  echo "nyaa-init: $@"
  exit 1
}

info() {
  echo "nyaa-init: $@"
}

chkroot() {
  if [ "$(id -u)" != "0" ]; then
    err "${RED}nyaa${NC}: you have to be root"
  fi
}

systemd_enable() {
  echo "WIP"
}

systemd_start() {
  echo "WIP"
}

# runit <-> nyaa-init <-> service
# Usage: nyaa-init enable service
runit_enable() {
  chkroot
  [ ! -f "/etc/nyaa.d/$1" ] && err "Service couldn't be found"
  
  if [ ! -d "/etc/sv/nyaa_$1" ]; then
    info "Creating service for runit"
    mkdir -p "/etc/sv/nyaa_$1"
    echo "#!/bin/sh" > "/etc/sv/nyaa_$1/run"
    echo "# This file is autogenerated by nyaa-init" >> "/etc/sv/nyaa_$1/run"
    echo "nyaa-init start $1" >> "/etc/sv/nyaa_$1/run"
  fi

    ln -s "/etc/sv/nyaa_$1" "/var/service/nyaa_$1" || err "Linking the created service failed"
    info "Linked /etc/sv/nyaa_$1 -> /var/service/nyaa_$1"
}

runit_start() {
  unset DEPENDS
  unset EXECPRE
  unset EXECPOST
  
  . "/etc/nyaa.d/$1" || err "Service doesn't exist"
  
  for i in "$(echo "$DEPENDS" | tr " " "\n")"
  do
    echo "$NAME depends on $i, starting $i"
    runit_start "$i"
  done

  info "starting $NAME, $DESC"
  $EXECPRE
  $EXEC
  $EXECPOST
}

runit_disable() {
  chkroot
  if [ -d "/etc/sv/nyaa_$1" ]; then
    info "Disabling runit service"
    rm -rf "/etc/sv/nyaa_$1"
    rm -rf "/var/service/nyaa_$1"
  else
    err "Service isn't enabled"
  fi
}

runit_status() {
  chkroot
  [ ! -d "/var/service/nyaa_$1" ] && err "Service doesn't exist"
  sv status "nyaa_$1"
}

detect_init() {
  case "$(ps -p 1 -o comm=)" in
    "systemd")
      systemd_"$1" "$2"
    ;;
    "runit")
      runit_"$1" "$2"
    ;;
    *)
      err "This init system isn't supported yet"
    ;;
  esac
}


case "$1" in
  "enable")
    detect_init enable "$2"
  ;;
  "start")
    detect_init start "$2"
  ;;
  "status")
    detect_init status "$2"
  ;;
  "disable")
    detect_init disable "$2"
  ;;
  *)
    echo "usage: nyaa-init [enable,start,status,disable] service"
esac
